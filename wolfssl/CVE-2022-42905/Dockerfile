FROM ubuntu:23.04

ARG WOLFSSL_VERSION
ARG HTTP_PROXY
ARG HTTPS_PROXY

RUN echo WolfSSL Version: $WOLFSSL_VERSION

# Change the Ubuntu package mirror
RUN apt update && apt install -y apt-transport-https ca-certificates
RUN sed -i 's@//.*archive.ubuntu.com@//mirrors.ustc.edu.cn@g' /etc/apt/sources.list && apt clean

# Install common dependencies
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    wget ca-certificates gnupg2 \
    apt-utils git build-essential curl sudo bison flex autoconf automake \
    libtool pkg-config git vim gdb lsb-release software-properties-common tcpdump \
    && rm -rf /var/lib/apt/lists

# Add a new user user, pass: user
RUN groupadd -g 1013 user && \
    useradd -u 1013 -rm -d /home/user -s /usr/bin/zsh -g user -G sudo user -p "$(openssl passwd -1 user)" && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
USER user
WORKDIR /home/user

RUN git config --global http.version HTTP/1.1 

# Clone wolfssl code repository from github
# gitee.com/zzroot/wolfssl.git is the mirror of github.com/wolfSSL/wolfssl.git
RUN git clone https://gitee.com/zzroot/wolfssl.git

RUN cd wolfssl && \
    git checkout $WOLFSSL_VERSION && \
    git describe --tags

# RUN echo "WOLFSSL_VERSION: $WOLFSSL_VERSION"
COPY poc.patch /home/user/

RUN cp -r /home/user/wolfssl /home/user/wolfssl-asan && \
    cd /home/user/wolfssl-asan && \
    ./autogen.sh && \
    git apply ../poc.patch && \
    CFLAGS="-O0 -fsanitize=address -g -DWOLFSSL_CALLBACKS -Wno-error -Wno-unused-but-set-variable -Wnested-externs -Wimplicit-function-declaration" \
    CXXFLAGS="-O0 -fsanitize=address -g -DWOLFSSL_CALLBACKS -Wno-error -Wno-unused-but-set-variable -Wnested-externs -Wimplicit-function-declaration" \
    ./configure --enable-static --enable-shared --enable-tls13 --enable-opensslextra --enable-tlsv12=no && \
    make -j

RUN cd /home/user/wolfssl && \
    ./autogen.sh && \
    ./configure --enable-static --enable-shared --enable-tls13 --enable-opensslextra --enable-tlsv12=no && \
    make -j

COPY mal-client.c /home/user/

RUN gcc -o mal-client mal-client.c -I/home/user/wolfssl/ -L/home/user/wolfssl/src/.libs -lwolfssl

COPY test.fullchain.pem /home/user/test.fullchain.pem
COPY test.key.pem /home/user/test.key.pem
COPY --chown=user:user mal-client-server.sh /home/user/mal-client-server.sh
RUN chmod +x /home/user/mal-client-server.sh

ENV ASAN_OPTIONS='abort_on_error=1:symbolize=0:detect_leaks=0:detect_stack_use_after_return=1:detect_container_overflow=0:poison_array_cookie=0:malloc_fill_byte=0:max_malloc_fill_size=16777216'
ENTRYPOINT [ "/bin/bash", "-c", "./mal-client-server.sh" ]
