FROM buildpack-deps:bullseye

ARG VERSION
ARG HTTP_PROXY
ARG HTTPS_PROXY

RUN echo WolfSSL Version: $WOLFSSL_VERSION

RUN apt install apt-transport-https ca-certificates

RUN sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list && apt clean

# Install common dependencies
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    wget ca-certificates gnupg2 \
    apt-utils git build-essential curl sudo bison flex autoconf automake \
    libtool pkg-config git vim lsb-release software-properties-common \
    && rm -rf /var/lib/apt/lists

# Add a new user ubuntu, pass: ubuntu
RUN groupadd ubuntu && \
    useradd -rm -d /home/ubuntu -s /bin/bash -g ubuntu -G sudo -u 1000 ubuntu -p "$(openssl passwd -1 ubuntu)" && \
    echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Use ubuntu as default username
USER ubuntu
WORKDIR /home/ubuntu

RUN git config --global http.version HTTP/1.1 

ENV ASAN_OPTIONS='abort_on_error=1:symbolize=0:detect_leaks=0:detect_stack_use_after_return=1:detect_container_overflow=0:poison_array_cookie=0:malloc_fill_byte=0:max_malloc_fill_size=16777216'

# Clone wolfssl code repository from github
RUN git clone https://github.com/wolfSSL/wolfssl.git && \
    cd wolfssl && \
    git checkout $WOLFSSL_VERSION
    
ENV CFLAGS="-fsanitize=address -g" CXXFLAGS="-fsanitize=address -g"

WORKDIR /home/ubuntu/wolfssl

RUN ./configure --enable-static --enable-shared=no --enable-tls13 --enable-cryptocb && \
    make -j

RUN gcc -o mal-client mal-client.c -I/home/ubuntu/wolfssl/include -L/home/ubuntu/wolfssl/src/.libs -lwolfssl

COPY test.fullchain.pem /home/ubuntu/test.fullchain.pem
COPY test.key.pem /home/ubuntu/test.key.pem

ENTRYPOINT [ "/bin/bash", "-c", "./mal-client_server.sh" ]