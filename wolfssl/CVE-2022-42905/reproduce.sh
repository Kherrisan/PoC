IMAGE=wolfssl-cve-2022-42905
WOLFSSL_VERSION=$2

cmd="docker build -t $IMAGE --build-arg version=$WOLFSSL_VERSION"

if [ ! -z "$HTTP_PROXY" ] || [ ! -z "$http_proxy" ] || [ ! -z "$HTTPS_PROXY" ] || [ ! -z "$https_proxy" ]; then
    # Replace host in HTTP_PROXY with docker host IP
    # Extract port from proxy URLs if present
    HTTP_PORT=$(echo $HTTP_PROXY | grep -oP ':\d+' | cut -d: -f2)
    [ -z "$HTTP_PORT" ] && HTTP_PORT=$(echo $http_proxy | grep -oP ':\d+' | cut -d: -f2)
    HTTPS_PORT=$(echo $HTTPS_PROXY | grep -oP ':\d+' | cut -d: -f2)
    [ -z "$HTTPS_PORT" ] && HTTPS_PORT=$(echo $https_proxy | grep -oP ':\d+' | cut -d: -f2)

    # Replace proxy host with Docker host IP
    HTTP_PROXY=$(echo $HTTP_PROXY | sed "s/[^:]*:/172.17.0.1:/")
    [ ! -z "$http_proxy" ] && http_proxy=$(echo $http_proxy | sed "s/[^:]*:/172.17.0.1:/")
    HTTPS_PROXY=$(echo $HTTPS_PROXY | sed "s/[^:]*:/172.17.0.1:/")
    [ ! -z "$https_proxy" ] && https_proxy=$(echo $https_proxy | sed "s/[^:]*:/172.17.0.1:/")
    
    cmd="$cmd --build-arg HTTP_PROXY=$HTTP_PROXY --build-arg HTTPS_PROXY=$HTTPS_PROXY"
fi

cmd="$cmd ."

echo "[+] Running: $cmd"
eval $cmd

echo "[+] Running container"
docker run --rm -v -it $IMAGE
